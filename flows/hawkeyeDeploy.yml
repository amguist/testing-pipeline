deploy:
  - log: "Hawkeye Concord | !!! GITHUB EVENT !!! ${event}"
  - checkpoint: "Start"
  - log: "Value of Completed Files/Stages: ${kittCompletedDeployment}"

  - expr: ${kittFilesGraph.size()}
    out: graphSize
  - if: ${graphSize > 0}
    then:
      - log: "Hawkeye Concord | Launching Processing Form, deploymentForm"
      - form: deploymentForm
        values:
          processId: ${txId}
          repo: ${repo}
          branch: ${branch}
          version: ${version}
          kittFilesGraph: ${kittFilesGraph}
      - log: "Values from original KittFiles Collection: ${kittFiles}"
      - expr: ${deploymentForm.onlySelectedKittFiles.stream().flatMap(str -> str.split(",").stream()).toList()}
        out: selectedKittFiles

      - call: kitt-deploy
        withItems: ${selectedKittFiles}
        in:
          stageRefs: [ "dev" ]
      - log: "Completed Files/Stages : ${kittCompletedDeployment}"

kitt-deploy:
  - log: "Hawkeye-Concord | Reading Contents of the kitt file ${item}"
  - set:
      deploymentSpecs:
        stage: ${stageRefs[0]}
        kittFile: ${item}

  - ${kittCompletedDeployment.add(deploymentSpecs)}
