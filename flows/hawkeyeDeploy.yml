deploy:
  - log: "Hawkeye Concord | !!! GITHUB EVENT !!! ${event}"
  - checkpoint: "Start"
  - expr: ${kittFilesGraph.size()}
    out: graphSize
  - if: ${graphSize > 0}
    then:
      - log: "Hawkeye Concord | Launching Processing Form, deploymentForm"
      - form: deploymentForm
        values:
          processId: ${txId}
          repo: ${repo}
          branch: ${branch}
          version: ${version}
          kittFilesGraph: ${kittFilesGraph}
      - log: "Values from original KittFiles Collection: ${kittFiles}"
      - expr: ${deploymentForm.onlySelectedKittFiles.stream().flatMap(str -> str.split(",").stream()).toList()}
        out: selectedKittFiles

      - expr: ${selectedKittFiles.stream().toList().size()}
        out: testListSize
      - if: ${testListSize > 0}
        then:
          - log: "Initial Value Of Test List: ${selectedKittFiles}"
          - set:
            testFiles: "${selectedKittFiles.add('Hello')}"
          - log: "New List is now equal to ${selectedKittFiles}"

      - log: "The Total Size Of Selected Kitt Files is: ${selectedKittFiles}"
      - call: kitt-deploy
        withItems: ${selectedKittFiles}
        in:
          stageRefs: [ "dev" ]
    else:
      - call: processEvent

kitt-deploy:
  - log: "Hawkeye-Concord | Reading Contents of the kitt file ${item}"
  - expr: ${kittCompletedDeployment.stream().filter(str -> !str.startsWith(item)).toList().size()}
    out: validFiles
  - if: ${validFiles <= 0}
    then:
      - log: "All files for ${item} have been successfully deployed already.  Skipping ... "

processEvent:
  - if: ${event != "push"} # The event could be either 'push' or 'pr'.  For actual deployments we only want non 'pr' stages
    then:
      # iterate through the list of kitt.deploy.stages
        - log: "Hawkeye-Concord | Deploying non PR stages"
    else:
      - log: "Hawkeye-Concord | Deploying PR stage"

onFailure:
  - log: "Hawkeye Concord | Pipeline failed to complete"