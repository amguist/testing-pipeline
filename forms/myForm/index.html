<!doctype html>
<html>
    <head>
        <title>Deploy Form</title>
        <script src="data.js"></script>
        <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
        <script src="../shared/semantic-UI/semantic.min.js"></script>
        <link rel="stylesheet" href="../shared/semantic-UI/semantic.min.css" />
        <link rel="stylesheet" href="../shared/dat-common.css" />
    </head>
    <body>
        <div id="root">
            <div class="ui centered grid">
                <div class="sixteen wide column topBar">
                    <div class="ui centered grid dat-page-header">
                        <div class="fourteen wide column topBarColumn">
                            <div class="ui small fluid inverted secondary menu">
                                <div class="item">
                                   <img id="concordLogo" src="../shared/logo.png" class="ui small image"/>
                                </div>
                                <div class="right vertically fitted item">
                                    <span>Powered by Hawkeye</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="fourteen wide column contentColumn">
                <h2 class="ui header"></h2>
                <form id="deploymentForm" class="ui form">
                    <div class="required field">
                        <label>Organization</label>
                        <div class="field">
                            <input id="onlyDeployOrg" name="onlyDeployOrg" type="text" class="ui input" readonly="true" value="Hawkeye"/>
                        </div>
                    </div>
                    <div class="required field">
                        <label>Repository</label>
                        <div>
                            <input id="onlyDeployRepo" name="onlyDeployRepo" type="text" class="ui input" readonly="true" />
                        </div>
                    </div>
                    <div class="required field">
                        <label>Branch</label>
                        <div>
                            <input id="onlyDeployBranch" name="onlyDeployBranch" type="text" class="ui input" readonly="true" />
                        </div>
                    </div>
                    <div class="required field">
                        <label>Kitt Files</label>
                        <select id="onlySelectedKittFiles" multiple="" class="ui fluid dropdown">
                            <option value="">Kitt Files</option>
                        </select>
                    </div>
                    <button class="ui primary button" id="customFormSubmitButton" type="submit">Submit</button>
                    <button class="ui button" type="button" onclick="redirectToProcessPage()">Back to Process Page</button>
                </form>
            </div>
        </div>

        <script type="text/javascript">
            function redirectToProcessPage() {
                window.location.replace("http://localhost:8001/#/process/" + data.values.processId + "/status");
            }

            function initializeFormElements() {
                $('#onlyDeployRepo').val(data.values.repo);
                $('#onlyDeployBranch').val(data.values.branch);
                $('.ui.dropdown').dropdown();

                let kittOptions = []
                for (const kittFile of data.values.kittFiles) {
                    let option = {
                        "name" : kittFile,
                        "value" : kittFile,
                        "text" : kittFile
                    }
                    kittOptions.push(option);
                }
                console.log(kittOptions);
                $('.ui.dropdown').dropdown({values: kittOptions});
            }

            $(document).ready(function() {
               initializeFormElements();
            });

            $("#deploymentForm").submit(function(e) {
                e.preventDefault();
                var button = document.getElementById("customFormSubmitButton");
                button.classList.add("loading");

                console.log($('.ui.dropdown').dropdown("get values");


                $.ajax({
                    type: "POST",
                    url: data.submitUrl,
                    data: $(this).serialize(),
                    success: function(data) {
                        button.classList.remove("loading");
                        redirectToProcessPage();
                    },
                    error: function(data) {
                        alert("Error in post - check browser console for details!");
                        console.log("ERROR: ");
                        console.log(data);
                        button.classList.remove("loading");
                    }
                });
            });
        </script>
    </body>
</html>